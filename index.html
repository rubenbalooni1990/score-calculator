<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Risk Score Calculator</title>
<style>
  body { font-family: Arial; margin: 30px; }
  select, input, button { padding: 6px; margin: 10px 0; width: 300px; }
  .param-row, .field-row { margin-bottom: 15px; }
  .result { margin-top: 20px; font-weight: bold; white-space: pre-line; }
  input.error { border: 2px solid red; }
</style>

</head>
<body>
  <h2>Risk Score Calculator</h2>

  <div class="field-row">
    <label>Customer Name: <input type="text" id="customerName"></label><br>
    <label>CR Number (10 digits):<input type="text" id="crNumber" class="numeric" inputmode="numeric"></label><br>
<label>Unified Number (10 digits):<input type="text" id="unifiedNumber" class="numeric" inputmode="numeric"></label><br>
<label>VAT Registration Number (15 digits):<input type="text" id="vatNumber" class="numeric" inputmode="numeric"></label>
  </div>

  <label for="tier">Select Tier:</label><br>
  <select id="tier" onchange="loadParameters()">
    <option value="">-- Choose Tier --</option>
    <option value="Tier 1">Tier 1 : SCF / 100K</option>
    <option value="Tier 2">Tier 2 : SCF / 200K</option>
    <option value="Tier 3">Tier 3 : SCF / 1M</option>
    <option value="Tier 4">Tier 4 : EDP / >1M</option>
  </select>

  <div id="parameters"></div>
  <button onclick="computeScore()">Compute Score</button>
  <button onclick="downloadPDF()">Download PDF</button>

  <div class="result" id="output"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const tierData = {
      "Tier 1": [
        { name: "CR Status", options: { "Active": 10, "Expired": 0 }, weight: 10 },
        { name: "Business Age", options: { "<6": 0, "6-11": 2, "12-23": 4, "24-35": 6, "36+": 10 }, weight: 20 },
        { name: "Owner Match", options: { "Yes": 10, "No": 0 }, weight: 5 }
      ],
      "Tier 2": [
        { name: "SIMAH Defaults", options: { "None": 10, "1-2": 5, "3+": 0 }, weight: 15 },
        { name: "Facility Ratio", options: { "<1.5": 10, "1.5-2.5": 5, ">2.5": 0 }, weight: 10 }
      ],
      "Tier 3": [
        { name: "Legal Structure", options: { "LLC": 10, "Establishment": 5 }, weight: 10 },
        { name: "Owner Match", options: { "Yes": 10, "No": 0 }, weight: 10 }
      ],
      "Tier 4": [
        { name: "SIMAH Owner Score", options: { "Excellent": 10, "Good": 8, "Fair": 5, "Poor": 0 }, weight: 15 },
        { name: "National Address Match", options: { "Yes": 10, "No": 0 }, weight: 5 }
      ]
    };

    function loadParameters() {
      const tier = document.getElementById('tier').value;
      const container = document.getElementById('parameters');
      container.innerHTML = '';

      if (!tierData[tier]) return;

      tierData[tier].forEach((param, idx) => {
        const row = document.createElement('div');
        row.className = 'param-row';

        const label = document.createElement('label');
        label.innerText = param.name;

        const select = document.createElement('select');
        select.id = `param-${idx}`;
        select.style.width = '300px';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.innerText = '-- Select --';
        select.appendChild(defaultOption);

        for (let [opt, score] of Object.entries(param.options)) {
          const option = document.createElement('option');
          option.value = score;
          option.innerText = opt;
          select.appendChild(option);
        }

        row.appendChild(label);
        row.appendChild(document.createElement('br'));
        row.appendChild(select);
        container.appendChild(row);
      });
    }

    function computeScore() {
  // Clear previous error highlights
  document.querySelectorAll('.numeric').forEach(el => el.classList.remove('error'));

  const cr = document.getElementById('crNumber');
  const un = document.getElementById('unifiedNumber');
  const vat = document.getElementById('vatNumber');

  let valid = true;

  if (!/^\d{10}$/.test(cr.value.trim())) {
    cr.classList.add('error');
    valid = false;
  }
  if (!/^\d{10}$/.test(un.value.trim())) {
    un.classList.add('error');
    valid = false;
  }
  if (!/^\d{15}$/.test(vat.value.trim())) {
    vat.classList.add('error');
    valid = false;
  }

  if (!valid) {
    alert('Please correct the highlighted fields:\n- CR and Unified Numbers must be 10 digits\n- VAT must be 15 digits');
    return;
  }

  const tier = document.getElementById('tier').value;
  if (!tierData[tier]) return;

  let total = 0;
  let totalWeight = 0;

  tierData[tier].forEach((param, idx) => {
    const score = parseFloat(document.getElementById(`param-${idx}`).value);
    if (!isNaN(score)) {
      total += (score * param.weight);
      totalWeight += param.weight;
    }
  });

  const finalScore = totalWeight > 0 ? (total / totalWeight).toFixed(2) : 0;

      let riskBand = '';
      if (finalScore >= 80) riskBand = 'Low Risk';
      else if (finalScore >= 60) riskBand = 'Moderate Risk';
      else if (finalScore >= 40) riskBand = 'High Risk';
      else riskBand = 'Very High Risk';

      const result = `Customer Name: ${document.getElementById('customerName').value}
CR Number: ${document.getElementById('crNumber').value}
Unified Number: ${document.getElementById('unifiedNumber').value}
VAT Registration Number: ${document.getElementById('vatNumber').value}

Score: ${finalScore} / 100
Risk Band: ${riskBand}`;

      document.getElementById('output').innerText = result;
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const outputText = document.getElementById('output').innerText || 'Please compute the score first.';
      const lines = outputText.split('\n');

      lines.forEach((line, i) => {
        doc.text(line, 10, 10 + i * 10);
      });

      doc.save('score-summary.pdf');
    }
  </script>
</body>
</html>
